#cloud-config

packages:
  - nginx
  - curl
  - ca-certificates

users:
  - name: relay
    sudo: []
    shell: /bin/bash
    ssh_authorized_keys:
      - ${indent(6, relay_public_key)}

write_files:
  # Map Vault private endpoint â†’ hybrid01 static IP
  - path: /etc/hosts
    append: true
    owner: root:root
    permissions: '0644'
    content: |
      192.168.122.101  vault-priv.privatelink.vault.azure.net

  # Static index.html served by nginx
  - path: /var/www/html/index.html
    owner: root:root
    permissions: '0644'
    content: |
      <!DOCTYPE html>
      <html>
      <head>
        <title>Hybrid Endpoint</title>
      </head>
      <body>
        <h1>Hybrid Endpoint Online</h1>
        <p>This page was generated during VM provisioning.</p>
      </body>
      </html>

  # Bootstrap script to fetch cert + key and configure nginx
  - path: /usr/local/bin/hybrid-bootstrap.sh
    permissions: '0755'
    owner: root:root
    content: |
      #!/bin/bash
      set -e

      echo "Installing Azure CLI..."
      curl -sL https://aka.ms/InstallAzureCLIDeb | bash

      echo "Authenticating to Azure..."
      az login --service-principal \
        --username "${AZ_CLIENT_ID}" \
        --password "${AZ_CLIENT_SECRET}" \
        --tenant "${AZ_TENANT_ID}" >/dev/null

      echo "Preparing directories..."
      mkdir -p /etc/nginx/ssl /var/www/html

      echo "Downloading certificate..."
      az keyvault secret download \
        --vault-name "${KEY_VAULT_NAME}" \
        --name "${CERT_SECRET_NAME}" \
        --file /etc/nginx/ssl/cert.pem \
        --encoding base64

      echo "Downloading key..."
      az keyvault secret download \
        --vault-name "${KEY_VAULT_NAME}" \
        --name "${KEY_SECRET_NAME}" \
        --file /etc/nginx/ssl/key.pem \
        --encoding base64

      chmod 600 /etc/nginx/ssl/key.pem

      echo "Configuring nginx..."
      cat >/etc/nginx/sites-available/hybrid.conf <<EOF
      server {
          listen 443 ssl;
          server_name _;

          ssl_certificate     /etc/nginx/ssl/cert.pem;
          ssl_certificate_key /etc/nginx/ssl/key.pem;

          root /var/www/html;
          index index.html;
      }
      EOF

      ln -sf /etc/nginx/sites-available/hybrid.conf /etc/nginx/sites-enabled/hybrid.conf
      rm -f /etc/nginx/sites-enabled/default

      echo "Restarting nginx..."
      systemctl restart nginx

runcmd:
  - [ bash, /usr/local/bin/hybrid-bootstrap.sh ]

