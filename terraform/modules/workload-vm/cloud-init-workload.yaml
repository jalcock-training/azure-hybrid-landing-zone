#cloud-config
package_update: true
packages:
  - ca-certificates
  - curl
  - unzip

write_files:
  # Fallback HTML content
  - path: /var/www/html/index.html.fallback
    permissions: '0644'
    content: |
      <!DOCTYPE html>
      <html>
      <head>
        <title>James' Training Workload</title>
      </head>
      <body>
        <h1>Hello, you've reached James' training workload.</h1>
        <p>This content is served from an Ubuntu VM in a secure Azure landing zone.</p>
        <p>f</p>
      </body>
      </html>

  # NGINX config (safe to write before install)
  - path: /etc/nginx/sites-available/default
    permissions: '0644'
    content: |
      server {
          listen 80 default_server;
          listen [::]:80 default_server;
          return 301 https://$host$request_uri;
      }

      server {
          listen 443 ssl;
          listen [::]:443 ssl;

          ssl_certificate     /etc/nginx/ssl/cert.pem;
          ssl_certificate_key /etc/nginx/ssl/key.pem;

          root /var/www/html;
          index index.html;

          server_name _;

          location / {
              try_files $uri $uri/ =404;
          }
      }

runcmd:
  - echo "[cloud-init] Starting workload setup" | tee -a /var/log/workload-init.log

  # Install Microsoft repo + Azure CLI
  - curl -sL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor | tee /etc/apt/trusted.gpg.d/microsoft.gpg > /dev/null
  - AZ_REPO=$(lsb_release -cs)
  - echo "deb [arch=amd64] https://packages.microsoft.com/repos/azure-cli/ $AZ_REPO main" | tee /etc/apt/sources.list.d/azure-cli.list
  - apt-get update -y
  - apt-get install -y azure-cli >> /var/log/workload-init.log 2>&1

  # Login using managed identity
  - echo "[cloud-init] Logging in with managed identity" | tee -a /var/log/workload-init.log
  - az login --identity >> /var/log/workload-init.log 2>&1

  # Ensure web root exists
  - mkdir -p /var/www/html

  # Attempt to download index.html from Storage
  - echo "[cloud-init] Downloading index.html from Storage" | tee -a /var/log/workload-init.log
  - az storage blob download \
      --account-name "${storage_account_name}" \
      --container-name "${storage_container_name}" \
      --name "index.html" \
      --file "/var/www/html/index.html" \
      --auth-mode login >> /var/log/workload-init.log 2>&1 || true

  # Fallback if download failed
  - |
      if [ ! -s /var/www/html/index.html ]; then
          echo "[cloud-init] Using fallback HTML" | tee -a /var/log/workload-init.log
          cp /var/www/html/index.html.fallback /var/www/html/index.html
      fi

  # TLS directory
  - mkdir -p /etc/nginx/ssl
  - chmod 700 /etc/nginx/ssl

  # Download certificate from Key Vault
  - echo "[cloud-init] Downloading certificate from Key Vault" | tee -a /var/log/workload-init.log
  - az keyvault secret download \
      --vault-name "${kv_name}" \
      --name "${kv_cert_name}" \
      --file "/etc/nginx/ssl/cert.pfx" >> /var/log/workload-init.log 2>&1 || true

  # Convert PFX â†’ PEM
  - |
      if [ -s /etc/nginx/ssl/cert.pfx ]; then
          echo "[cloud-init] Converting PFX to PEM" >> /var/log/workload-init.log

          openssl pkcs12 \
            -in /etc/nginx/ssl/cert.pfx \
            -nocerts -nodes \
            -out /etc/nginx/ssl/key.pem \
            -passin pass:"" >> /var/log/workload-init.log 2>&1

          openssl pkcs12 \
            -in /etc/nginx/ssl/cert.pfx \
            -clcerts -nokeys \
            -out /etc/nginx/ssl/cert.pem \
            -passin pass:"" >> /var/log/workload-init.log 2>&1

          chmod 600 /etc/nginx/ssl/key.pem /etc/nginx/ssl/cert.pem
      else
          echo "[cloud-init] No certificate downloaded" | tee -a /var/log/workload-init.log
      fi

  # Install nginx AFTER certs exist
  - echo "[cloud-init] Installing nginx" | tee -a /var/log/workload-init.log
  - apt-get install -y nginx >> /var/log/workload-init.log 2>&1

  # Enable + restart nginx
  - systemctl enable nginx
  - systemctl restart nginx

  - echo "[cloud-init] Workload setup complete" | tee -a /var/log/workload-init.log

